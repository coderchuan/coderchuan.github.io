## 镜像与容器
* 安装 
    * ubuntu、centos
        1. `curl -fsSL https://get.docker.com -o get-docker.sh`
        1. `sh get-docker.sh`
* 更改源
    1. 找到源配置文件
        * `init(upstart)`方式管理的系统:`/etc/default/docker`
        * `systemd`方式管理的系统:`/etc/docker/daemon.json`
    1. 确定要更换的源,有以下源可用:
        * 百度：`https://mirror.baidubce.com`
        * 阿里:`https://registry.cn-hangzhou.aliyuncs.com`
        * 腾讯:`https://mirror.ccs.tencentyun.com`
        * docker中国:`https://registry.docker-cn.com`
        * 网易:`http://hub-mirror.c.163.com`
    1. 修改源配置文件:
        * `init(upstart)`方式管理的系统,新增以下行,其中URL为源网址,如果已经存在则修改`URL`即可:
            ```
            DOCKER_OPTS="--registry-mirror=URL"
            ```
        * `systemd`方式管理的系统,新增以下行,其中URL为源网址,如果已经存在则修改`URL`即可:
            ```json
            {   
                "registry-mirrors": ["URL"] 
            }
            ```
* docker服务命令`启动|状态|停止|重启`
    * init方式:`service docker start`
    * systemd:`systemctl start docker`
* docker镜像(只读)
    * 搜索镜像:`docker search IMAGE_NAME`:`IMAGE_NAME`表示镜像名称
    * 拉取镜像:`docker pull IMAGE_NAME[:TAG]`:`IMAGE_NAME`表示镜像名称,`TAG`表示镜像标签。省略`:TAG`时使用`latest`作为标签
    * 已安装镜像
        * `docker images`:已安装镜像列表(镜像ID截取前12位) 
        * `docker images --no-trunc`:已安装镜像列表(完整的镜像ID) 
    * 删除镜像(删除镜像前应该先删除基于此镜像启动的容器)
        * `docker rmi [-f] IMAGE_ID`:删除镜像id为`IMAGE_ID`的镜像,`-f`表示强制删除。
    * 从容器打包镜像
        * `docker commit [OPTIONS] CONTAINER_ID IMAGE_NAME[:TAG]`
            * `OPTIONS`
                * `-a`:作者
                * `-m`:备注
            * `CONTAINER_ID`:容器ID
            * `IMAGE_NAME`:将要保存的镜像名称
            * `TAG`:将要保存的镜像标签。省略此标签默认使用`latest`作为标签名  
    * 镜像保存为文件、从文件加载为镜像
        * 保存为文件`docker save -o PATH IMAGES`
            * `PATH`:保存镜像文件的路径
            * `IMAGES`:`镜像名称[:镜像标签]`,多个镜像之间使用空格分隔 
        * 从文件加载镜像`docker load -i PATH`
            * `PATH`:打包好的镜像文件的路径 
* docker容器(由镜像创建,容器可写,可打包为新的镜像) 
    * 创建、启动、执行命令、停止
        * 基本操作
            * 创建容器`docker create [--name=NAME] [START_PARAM] [OPTION] IMAGE_NAME[:TAG] [COMMAND]`
                * 参数
                    * `NAME`:指定容器名称 
                    * `[START_PARAM]`:启动参数,有以下参数可选:
                        * `--restart=RESTART_POLICY`:重启策略,`RESTART_POLICY`为text,可取以下值:
                            * `no`:默认值。不自动启动 
                            * `on-failure[:NUMBER]`:若容器上次为非正常退出则重启容器。`NUMBER`为重试次数,默认为1
                            * `always`:容器总是在docker服务启动后自动启动 
                    * `OPTION`:操作参数
                        * `-it`:为具有交互能力的`COMMAND`开启一个交互式终端前台进程。如果`COMMAND`不具有交互能力,则此参数无效 
                        * `-d`:执行`COMMAND`后保持容器在后台运行(即使有交互式终端)
                        * `-p HOST_SYSTEM_PORT:CONTAINER_PORT` 
                            * `HOST_SYSTEM_PORT`:宿主机端口,可以为以下形式
                                * `HOST:PORT`,把宿主机的指定IP指定端口映射到容器中
                                * `HOST`,把宿主机的所有端口映射到容器中 
                            * `CONTAINER_PORT`:容器端口,例如`80`
                            * 示例
                                * `-p8888:80`,把宿主机的8888端口映射到容器的80端口
                                * `-p127.0.0.1:4000`,把宿主机的`127.0.0.1`上的所有端口映射到容器的4000端口 
                                * `-p127.0.0.1:80:80`,把宿主机的`127.0.0.1`上的80端口映射到容器的80端口 
                    * `IMAGE_NAME[:TAG]`:`IMAGE_NAME`表示镜像名称,`TAG`表示镜像标签。省略`:TAG`时使用`latest`作为标签
                    * `COMMAND`:当容器启动时要在容器中执行的命令(此命令为主线程,当主线程的前台进程结束后容器停止运行)。省略此参数则使用容器内默认的终端作为执行命令
                * 已创建的容器:`docker ps -a [--no-trunc]`。`--no-trunc`表示显示容器完整的ID
                * 示例 
                    * `docker create busybox`。创建一个镜像名称为`busybox:latest`的容器
                    * `docker create --name=mybusy busybox`。创建一个镜像名称为`busybox:latest`的容器,并命名为`mybusy`
                    * `docker create busybox cal`。创建一个镜像名称为`busybox:latest`的容器并且容器启动时默认执行`cal`命令 
                    * `docker create -it ubuntu /bin/bash`。创建一个镜像名称为`ubuntu:latest`的容器并且容器启动时默认打开并保持交互式终端
            * 启动容器(不进入容器)
                * 启动`docker start CONTAINER_ID`,其中`CONTAINER_ID`表示容器ID或容器名称,多个容器ID或名称用空格分隔
                * 重启:`docker restart CONTAINER_ID`
                * 已启动的容器:`docker ps`
            * 进入容器:`docker attach CONTAINER_ID`(实际是进入容器的主线程交互界面) 
            * 容器执行命令:`docker exec [OPTION] CONTAINER_ID COMMAND`
                * 参数
                    * `OPTION`:同`创建容器`中的OPTION 
                    * `CONTAINER_ID`:容器ID 
                    * `COMMAND`:要执行的命令 
                * 示例  
                    * `docker exec 0ffb9635db7f date`:在已经启动的容器中执行`date`命令 
                    * `docker exec -it 0ffb9635db7f /bin/bash`:在已经启动的容器中执行`/bin/bash`命令,并保持交互式终端开启状态
            * 停止容器
                * 安全停止:`docker stop CONTAINER_ID`
                * 强制停止:`docker kill CONTAINER_ID`
        * 组合操作 
            * 创建、运行、执行:`docker run [--name=NAME] [START_PARAM] [OPTION] IMAGE_NAME[:TAG] [COMMAND]`
                * `NAME`:同`创建容器`
                * `START_PARAM`:同`创建容器`
                * `OPTION`:同`创建容器`
                * 示例 
                    * `docker run --name=mybusy busybox`。创建一个镜像名称为`busybox:latest`的容器,并命名为`mybusy`
                    * `docker run busybox cal`。创建一个镜像名称为`busybox:latest`的容器并在容器中执行`cal`命令 
                    * `docker run -it ubuntu /bin/bash`。创建一个镜像名称为`ubuntu:latest`的容器,并打开交互式终端进入容器
    * 已存在的容器端口映射增加/修改 
        * 相关文件及对应项的值的格式
            * 文件路径:`/var/lib/docker/containers/CONTAINER_ID/hostconfig.json`,`CONTAINER_ID`是容器的完整ID 
                * 键:`PortBindings`
                * 值格式:
                    ```json 
                    {
                        "80/tcp": [
                            {
                                "HostIp": "127.0.0.1",
                                "HostPort": "8888"
                            }
                        ],
                        "81/tcp": [
                            {
                                "HostIp": "127.0.0.1",
                                "HostPort": "8889"
                            }
                        ]
                    }
                    ```
                * 值含义
                    * `80/tcp`,映射到容器的端口,其中`80`可修改。容器同一个端口可以对应多个宿主机的映射。此处映射了两个端口`80`和`81`
                    * `80/tcp`键对应的值:每个数组元素是一个json子项,表示一条宿主机的IP和端口,意义为宿主机的IP和端口映射到容器端口
                        * `HostIp`:宿主机IP
                        * `HostPort`:宿主机端口 
            * 文件路径:`/var/lib/docker/containers/CONTAINER_ID/config.v2.json`,`CONTAINER_ID`是容器的完整ID 
                * 键:`Config.ExposedPorts`(如果没有则添加) 
                * 值格式: 
                    ```json
                    {
                        "80/tcp": {},
                        "81/tcp": {} 
                    }
                    ```
                * 值含义
                    * `80/tcp`,容器暴露的端口,其中`80`可修改。应与`hostconfig.json`保持一致。此处暴露了两个端口`80`和`81` 
                    * `80/tcp`键对应的值:保持为`{}`即可
        * 增加/修改映射的步骤
            * 停止所有容器 
            * 停止docker服务
            * 修改`hostconfig.json`文件
            * 修改`config.v2.json`文件
            * 启动docker服务
            * 启动容器
    * 更改容器启动参数:`docker update OPTIONS CONTAINER_ID`
        * `OPTIONS`:要更改的参数
            * `--restart=RESTART_POLICY`:同`创建容器`
        * `CONTAINER_ID`:容器ID
    * 常用示例
        * 创建容器:`sudo docker run -it ubuntu:latest /bin/bash`。创建并进入,`ubuntu:latest`是镜像名称与标签。
        * 启动容器:`sudo docker start 2c39efab0a2c`。当容器停止后启动,`2c39efab0a2c`是容器ID。
        * 进入容器:`sudo docker exec -it 2c39efab0a2c /bin/bash`。当容器在后台运行时进入,`2c39efab0a2c`是容器ID。
        * 进入容器:`sudo docker attach 2c39efab0a2c`。当容器在后台运行时进入主线程,`2c39efab0a2c`是容器ID。
        * 停止容器:`sudo docker stop 2c39efab0a2c`。当容器正在运行时停止,`2c39efab0a2c`是容器ID。
* 宿主机与容器互传文件
    * 宿主机向容器传输:`docker cp -r HOST_PATH CONTAINER_ID:CONTAINER_PATH`
    * 容器向宿主机传输:`docker cp -r CONTAINER_ID:CONTAINER_PATH HOST_PATH`